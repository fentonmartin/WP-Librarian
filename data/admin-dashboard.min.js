function wp_lib_api_call(params,postCallFunction){params.action='wp_lib_api';wp_lib_send_ajax(params,postCallFunction);}
function wp_lib_do_action(dashAction,params){var data={action:'wp_lib_action',dash_action:dashAction};if(wp_lib_vars.hasOwnProperty('dash_page')){data.ref=wp_lib_vars.dash_page;}
switch(dashAction){case'run-test-loan':data.item_id=params['item_id'];break;case'loan':data.item_id=params['item_id'];data.member_id=params['member_id'];data.loan_length=params['loan_length'];break;case'schedule':data.item_id=params['item_id'];data.member_id=params['member_id'];data.start_date=params['start_date'];data.end_date=params['end_date'];break;case'return-item-no-fine':data.fine_member=false;data.dash_action='return-item';case'return-item':data.item_id=params['item_id'];data.end_date=params['end_date'];break;case'give-item':data.loan_id=params['loan_id'];if(params.hasOwnProperty('give_date')){data.give_date=params['give_date'];}
break;case'renew-item':data.loan_id=params['loan_id'];data.renewal_date=params['renewal_date'];break;case'fine-member':data.fine_member=true;data.dash_action='return-item';data.item_id=params['item_id'];break;case'cancel-fine':data.fine_id=params['fine_id'];break;case'pay-fine':data.member_id=params['member_id'];data.fine_payment=params['fine_payment'];break;case'delete-object':data.post_id=params['post_id'];data.deletion_confirmed=true;break;case'clean-item':data.item_id=params['item_id'];break;case'scan-barcode':data.code=params['item_barcode'];break;}
data.wp_lib_ajax_nonce=params[WP_LIB_NONCE];wp_lib_send_ajax(data,function(serverResponse){switch(serverResponse[0]){case 4:wp_lib_load_page();break;case 3:if(serverResponse[1][1].length===0){wp_lib_local_error('The action could not be completed but the server did not explain why');}
break;}});}
function wp_lib_load_page(ajaxData,stateLoad){if(typeof stateLoad==='undefined'){var stateLoad='dynamic';}
if(typeof ajaxData==='undefined'){var ajaxData={};}
if(!ajaxData.hasOwnProperty('dash_page')||ajaxData.dash_page==''){ajaxData.dash_page='dashboard';}
ajaxData.action='wp_lib_page';if(wp_lib_vars.hasOwnProperty('dash_page')){ajaxData.ref=wp_lib_vars.dash_page;}
wp_lib_send_ajax(ajaxData,function(serverResponse){switch(serverResponse[0]){case 3:if(serverResponse[1][1].length===0){wp_lib_local_error('Server encounted error while loading page but didn\'t specify why');}
break;case 4:wp_lib_render_page(serverResponse[1][2]);wp_lib_vars.dash_page=ajaxData.dash_page;if(stateLoad!='history'){delete ajaxData.action;delete ajaxData.ref;if(ajaxData.dash_page=='dashboard'){delete ajaxData.dash_page;}
if(ajaxData.wp_lib_ajax_nonce){delete ajaxData.wp_lib_ajax_nonce;}
var currentPage=wp_lib_vars.dashUrl;var serialAjaxData=jQuery.param(ajaxData);if(serialAjaxData!=''){currentPage+='&'+serialAjaxData;}
if(stateLoad=='first'){history.replaceState(ajaxData,wp_lib_format_tab_title(serverResponse[1].title),currentPage);}else if(stateLoad=='dynamic'){history.pushState(ajaxData,wp_lib_format_tab_title(serverResponse[1].title),currentPage);}else{return;}}
break;default:return false;break;}});}
function wp_lib_render_page(pageArray){var $=jQuery;wp_lib_vars.getParams={};$('#page-title').html(pageArray[0]);document.title=wp_lib_format_tab_title(pageArray[1]);var libWorkspace=$('#wp-lib-workspace').empty();var urlBase=wp_lib_vars.dashUrl;var formDashPageButtons=[];pageArray[2].forEach(function(e,i){wp_lib_render_page_element(e,libWorkspace);});if(pageArray[3]instanceof Array){$(pageArray[3]).each(function(i,scriptURL){wp_lib_get_script(scriptURL);});}else if(typeof pageArray[3]==='string'){wp_lib_get_script(pageArray[3]);}}
function wp_lib_get_script(scriptURL){jQuery.ajax({dataType:'script',cache:!wp_lib_vars.debugMode,url:scriptURL}).fail(function(jqxhr,settings,exception){wp_lib_local_error("Failed to load JavaScript needed for this page");console.log('Script URL: '+scriptURL);console.log(exception);}).success(function(){var moduleName=scriptURL.match(/.*\/(.+?)\./)[1];if(window[moduleName]instanceof Object&&window[moduleName].init instanceof Object){window[moduleName].init();}});}
function wp_lib_render_page_element(pageItem,theParent){var $=jQuery;elementObject=wp_lib_init_object(pageItem);if(pageItem.hasOwnProperty('classes')){if(pageItem.classes instanceof Array){elementObject['class']=pageItem.classes.join(' ');}else if(typeof pageItem.classes==='string'){elementObject['class']=pageItem.classes;}}
if(pageItem.hasOwnProperty('label')){theParent=$('<label/>',{'for':pageItem.label}).appendTo(theParent);}
switch(pageItem.type){case'hidden':var theElement=$('<input/>',elementObject).attr('type',pageItem.type);wp_lib_vars.getParams[elementObject.name]=elementObject.value;break;case'nonce':var theElement=$('<input/>',elementObject).attr({'type':'hidden','id':WP_LIB_NONCE,'name':WP_LIB_NONCE});break;case'button':var theElement=$('<a/>',elementObject).addClass('dash-button dash-button-medium');theElement.attr('type','button');switch(pageItem.link){case'page':theElement.attr('name','dash_page');break;case'action':theElement.attr('name','dash_action');break;case'url':theElement.attr({onclick:wp_lib_vars.onClick});break;case'edit':var postID=0;if(wp_lib_vars.getParams.hasOwnProperty('item_id')){postID=wp_lib_vars.getParams.item_id;}else if(wp_lib_vars.getParams.hasOwnProperty('member_id')){postID=wp_lib_vars.getParams.member_id;}
theElement.attr({href:wp_lib_vars.adminUrl+'post.php?action=edit&post='+postID,onclick:wp_lib_vars.onClick});break;case'none':theElement.attr('name','dash_blank');break;default:wp_lib_render_page_element({},theParent);return;break;}
if(pageItem.hasOwnProperty('icon')){theElement.html($('<div/>',{'class':'dash-icon dash-icon-medium dashicons dashicons-'+pageItem.icon,})).addClass('dash-icon-medium-parent');}
break;case'dash-url':var theElement=$('<form/>',{'class':'dash-url-form'});$.each(pageItem.params,function(paramName,paramValue){theElement.append($('<input/>',{type:'hidden',name:paramName,value:paramValue}));});theElement.append($('<a/>',elementObject).attr('href',wp_lib_vars.dashUrl+'&'+$.param(pageItem.params)).addClass('dash-url'));break;case'dash-button':theElement=$('<a/>',elementObject).addClass('dash-button dash-button-large');theElement.attr('type','button');switch(pageItem.link){case'dash-page':theElement.attr('name','dash_page');break;case'post-type':theElement.attr({href:wp_lib_vars.adminUrl+'edit.php?post_type='+pageItem.cpt,onclick:wp_lib_vars.onClick});break;case'admin-url':theElement.attr({href:wp_lib_vars.adminUrl+pageItem.url,onclick:wp_lib_vars.onClick});break;case'url':theElement.attr({href:pageItem.url,onclick:wp_lib_vars.onClick});break;}
if(!pageItem.hasOwnProperty('icon')){pageItem.icon='no';}
theElement.html($('<div/>',{'class':'dash-button-wrapper',html:[$('<div/>',{'class':'dash-icon dash-icon-large dashicons dashicons-'+pageItem.icon,}),$('<h4/>',{'class':'dash-button-text',html:pageItem.bName})]}));break;case'paras':if(pageItem.hasOwnProperty('content')){if(pageItem.content instanceof Array){elementObject.html=[];$(pageItem.content).each(function(i,e){elementObject.html.push($('<p/>',{html:e}));});}else if(typeof pageItem.content==='string'){elementObject.html=$('<p/>',{html:pageItem.content});}}
var theElement=$('<div/>',elementObject).addClass('dash-paras');break;case'date':var theElement=$('<input/>',elementObject).attr({type:pageItem.type}).addClass('dash-datepicker').datepicker();$('#ui-datepicker-div').addClass('ll-skin-melon');break;case'input':var theElement=$('<input/>',elementObject);if(pageItem.hasOwnProperty('attr')){$(pageItem.attr).each(function(i,anAttr){theElement.attr(anAttr,pageItem.attr[anAttr]);});}
theElement.keydown(function(event){if(event.keyCode==13){theElement.siblings('a[type="button"]').click();}});break;case'select':var theElement=$('<select/>',elementObject);var elementSelectOptions=[];$(pageItem.options).each(function(i,selectOption){elementSelectOptions.push($('<option/>',{'value':selectOption.value,'html':selectOption.html,'class':pageItem.optionClass}));});theElement.html(elementSelectOptions);break;case'header':var theElement=$('<h'+pageItem.size+'/>',elementObject);break;case'div':var theElement=$('<div/>',elementObject);$(pageItem.inner).each(function(i,e){wp_lib_render_page_element(e,theElement);});break;case'strong':var theElement=$('<strong/>',elementObject);break;case'metabox':var theElement=$('<div/>',elementObject).addClass('lib-metabox').append($('<strong/>',{html:pageItem.title}));var metaFields=[];$(pageItem.fields).each(function(i,e){var fieldName=e[0];var fieldData=e[1];if(fieldData instanceof Array){if(fieldData.length>1){fieldName+='s';}
var multiUrlOutput=[];$(fieldData).each(function(i,taxData){if(i>0){multiUrlOutput.push(', ');}
multiUrlOutput.push($('<a/>',{href:taxData[1],html:taxData[0]}));});fieldData=multiUrlOutput;}else if(fieldData instanceof Object){fieldData=wp_lib_render_page_element(fieldData);}
metaFields.push($('<tr/>',{'class':'meta-row',html:[$('<th/>',{'html':fieldName+':'}),$('<td/>',{'html':fieldData})]}));});theElement.append($('<table/>',{'class':'lib-metabox','html':metaFields}));break;case'form':var theElement=$('<form/>',elementObject);theElement.addClass('lib-form');theElement.attr('onsubmit','return false;');if(pageItem.hasOwnProperty('content')&&pageItem.content instanceof Array){var urlBase=wp_lib_vars.dashUrl;pageItem.content.forEach(function(e,i){if(e.hasOwnProperty('type')&&e.type==='hidden'){urlBase+='&'+e.name+'='+e.value;}});pageItem.content.forEach(function(e,i){var formElement=wp_lib_render_page_element(e,theElement);if(e.hasOwnProperty('type')&&e.type==='button'&&e.link==='page'){formElement.attr('href',urlBase+'&dash_page='+e.value);}});}
break;case'dtable':var tableHead=$('<thead/>',{});$(pageItem.headers).each(function(i,header){$('<th/>',{html:header}).appendTo(tableHead);});if(!pageItem.hasOwnProperty('id')){elementObject.id='dynamic-table-'+Math.floor((Math.random()*100)+1);}
var theTable=$('<table/>',elementObject).addClass(['dynatable-table','wp-list-table','widefat','fixed','posts'].join(' ')).html([tableHead,$('<tbody/>',{})]);var tableRecords=[];$.each(pageItem.data,function(i,row){var tableRow={};$.each(row,function(columnName,columnData){if(columnData instanceof Object){columnData=wp_lib_render_page_element(columnData).prop('outerHTML');}
tableRow[columnName]=columnData;});tableRecords.push(tableRow);});if(!pageItem.hasOwnProperty('labels')||!pageItem.labels.hasOwnProperty('records')){pageItem.labels={records:'records'};}
var theElement=$('<div/>',{'class':'dynatable-wrap',html:theTable}).appendTo(theParent);theTable.dynatable({dataset:{records:tableRecords,perPageDefault:10,perPageOptions:[10,20,50,100]},params:{records:pageItem.labels.records},inputs:{processingText:'<div class="dtable-process-wrap"><div class="dtable-process-icon dashicons dashicons-book-alt"></div></div>'}});$('.dynatable-head').each(function(i,tableHeader){$(tableHeader).addClass('manage-column');});return;break;case'item-list':var theTable=$('<ul/>',elementObject).addClass('item-list');function render_item_row(rowIndex,record,columns,cellWriter){var listItemElements=[$('<input/>',{type:'hidden',name:'item_id',value:record.item_id})],manageItemURL=wp_lib_vars.dashUrl+'&dash_page=manage-item&item_id='+record.item_id,coverLink=$('<a/>',{'href':manageItemURL,'class':'item-cover-link',});listItemElements.push(coverLink);if(record.cover!==false){coverLink.append($('<div/>',{'class':'item-thumbnail','html':$('<div/>',{'class':'item-thumbnail-centrefix','html':$('<img/>',{'src':record.cover[0],'class':'item-thumbnail',})})}));}else{coverLink.append($('<div/>',{'class':'item-no-thumbnail','href':manageItemURL,}));}
if(record.title.length>50){record.title=record.title.substring(0,48)+'...';}
var itemMeta=[$('<h4/>',{'class':'item-title','html':record.title})];if(record.authors!=false){var allAuthors=record.authors.join(', ');if(allAuthors.length>45){allAuthors=allAuthors.substring(0,43)+'...';}
itemMeta.push($('<p/>',{'class':'item-authors','html':'Authors: '+allAuthors}));}
itemMeta.push($('<p/>',{'class':'item-status','html':'Status: '+record.status}));listItemElements.push($('<div/>',{'class':'item-meta','html':itemMeta}));var singleItem=$('<li/>',{'class':'single-item'});var localParent=$('<form/>',{'html':listItemElements}).appendTo(singleItem);if(record.late==true){singleItem.addClass('late-item');}
wp_lib_render_page_element({type:'button',link:'page',value:'manage-item',html:'Manage',classes:'item-manage',href:manageItemURL,},localParent);wp_lib_render_page_element({type:'button',link:'url',href:record.view,html:'View',classes:'item-view'},localParent);return singleItem.prop('outerHTML');}
var theElement=$('<div/>',{'class':'item-list-wrap',html:theTable}).appendTo(theParent);theTable.dynatable({table:{bodyRowSelector:'li'},writers:{_rowWriter:render_item_row},dataset:{records:pageItem.data,perPageDefault:20,perPageOptions:[20,40,60,100]},params:{records:'items'},inputs:{processingText:'<div class="dtable-process-wrap"><div class="dtable-process-icon dashicons dashicons-book-alt"></div></div>'}});return;break;default:if(wp_lib_vars.debugMode){console.log('Dash element has unknown element type:');console.log(pageItem);var theElement=$('<strong/>',{'html':'UNKNOWN ELEMENT TYPE<br/>','style':'color:red;'});}else{var theElement=$('<div/>',{});}
break;}
if(typeof theParent!=='undefined'){theElement.appendTo(theParent);}
return theElement;}
function wp_lib_format_tab_title(title){return title+' ‹ '+wp_lib_vars.siteName;}
jQuery(function($){$.dynatableSetup({table:{headRowSelector:'thead'},features:{pushState:false}});$.datepicker.setDefaults({dateFormat:'yy-mm-dd',inline:true,showOtherMonths:true});var GetVars=wp_lib_vars.getParams;delete GetVars["post_type"];delete GetVars["page"];wp_lib_load_page(GetVars,'first');window.onpopstate=function(event){wp_lib_load_page(event.state,'history');}
jQuery('#wp-lib-workspace').on('click','a[name="dash_action"]',function(e){var action=e.currentTarget.value;var params=wp_lib_collect_form_params(e.target);wp_lib_do_action(action,params);return false;});jQuery('#wp-lib-workspace').on('click','a[name="dash_page"], a.dash-url',function(e){var params=wp_lib_collect_form_params(e.target);if(e.currentTarget.getAttribute('name')==='dash_page'){params.dash_page=e.currentTarget.getAttribute('value');delete params.wp_lib_ajax_nonce;}
if(e.ctrlKey){return true;}else{wp_lib_load_page(params);return false;}});jQuery('#wp-lib-workspace').on('click','a.item-cover-link',function(e){var params=wp_lib_collect_form_params(e.target);params.dash_page='manage-item';if(e.ctrlKey){return true;}else{wp_lib_load_page(params);return false;}});});