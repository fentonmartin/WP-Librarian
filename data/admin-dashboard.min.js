function wp_lib_api_call(a,b){a.action='wp_lib_api';wp_lib_send_ajax(a,b);}function wp_lib_do_action(a,b){var c={action:'wp_lib_action',dash_action:a};if(wp_lib_vars.hasOwnProperty('dash_page'))c.ref=wp_lib_vars.dash_page;switch(a){case 'run-test-loan':c.item_id=b.item_id;break;case 'loan':c.item_id=b.item_id;c.member_id=b.member_id;c.loan_length=b.loan_length;break;case 'schedule':c.item_id=b.item_id;c.member_id=b.member_id;c.start_date=b.start_date;c.end_date=b.end_date;break;case 'return-item-no-fine':c.fine_member=false;c.dash_action='return-item';case 'return-item':c.item_id=b.item_id;c.end_date=b.end_date;break;case 'give-item':c.loan_id=b.loan_id;if(b.hasOwnProperty('give_date'))c.give_date=b.give_date;break;case 'renew-item':c.loan_id=b.loan_id;c.renewal_date=b.renewal_date;break;case 'fine-member':c.fine_member=true;c.dash_action='return-item';c.item_id=b.item_id;break;case 'cancel-fine':c.fine_id=b.fine_id;break;case 'pay-fine':c.member_id=b.member_id;c.fine_payment=b.fine_payment;break;case 'delete-object':c.post_id=b.post_id;c.deletion_confirmed=true;break;case 'clean-item':c.item_id=b.item_id;break;case 'scan-barcode':c.code=b.item_barcode;break;}c.wp_lib_ajax_nonce=b[WP_LIB_NONCE];wp_lib_send_ajax(c,function(a){switch(a[0]){case 4:wp_lib_load_page();break;case 3:if(a[1][1].length===0)wp_lib_local_error('The action could not be completed but the server did not explain why');break;}});}function wp_lib_load_page(a,b){if(typeof b==='undefined')var b='dynamic';if(typeof a==='undefined')var a={};if(!a.hasOwnProperty('dash_page')||a.dash_page=='')a.dash_page='dashboard';a.action='wp_lib_page';if(wp_lib_vars.hasOwnProperty('dash_page'))a.ref=wp_lib_vars.dash_page;wp_lib_send_ajax(a,function(c){switch(c[0]){case 3:if(c[1][1].length===0)wp_lib_local_error('Server encounted error while loading page but didn\'t specify why');break;case 4:wp_lib_render_page(c[1][2]);wp_lib_vars.dash_page=a.dash_page;if(b!='history'){delete a.action;delete a.ref;if(a.dash_page=='dashboard')delete a.dash_page;if(a.wp_lib_ajax_nonce)delete a.wp_lib_ajax_nonce;var d=wp_lib_vars.dashUrl;var e=jQuery.param(a);if(e!='')d+='&'+e;if(b=='first')history.replaceState(a,wp_lib_format_tab_title(c[1].title),d);else if(b=='dynamic')history.pushState(a,wp_lib_format_tab_title(c[1].title),d);else return;}break;default:return false;break;}});}function wp_lib_render_page(a){var b=jQuery;wp_lib_vars.getParams={};b('#page-title').html(a[0]);document.title=wp_lib_format_tab_title(a[1]);var c=b('#wp-lib-workspace').empty();var d=wp_lib_vars.dashUrl;var e=[];a[2].forEach(function(a,b){wp_lib_render_page_element(a,c);});if(a[3] instanceof Array)b(a[3]).each(function(a,c){b.getScript(wp_lib_vars.pluginsUrl+'/scripts/'+c+'.js').fail(function(a,b,c){wp_lib_local_error("Failed to load JavaScript needed for this page");});});}function wp_lib_render_page_element(a,b){var c=jQuery;elementObject=wp_lib_init_object(a);if(a.hasOwnProperty('classes'))if(a.classes instanceof Array)elementObject['class']=a.classes.join(' ');else if(typeof a.classes==='string')elementObject['class']=a.classes;if(a.hasOwnProperty('label'))b=c('<label/>',{'for':a.label}).appendTo(b);switch(a.type){case 'hidden':var d=c('<input/>',elementObject).attr('type',a.type);wp_lib_vars.getParams[elementObject.name]=elementObject.value;break;case 'nonce':var d=c('<input/>',elementObject).attr({'type':'hidden','id':WP_LIB_NONCE,'name':WP_LIB_NONCE});break;case 'button':var d=c('<a/>',elementObject).addClass('dash-button dash-button-medium');d.attr('type','button');switch(a.link){case 'page':d.attr('name','dash_page');break;case 'action':d.attr('name','dash_action');break;case 'url':d.attr({onclick:wp_lib_vars.onClick});break;case 'edit':var e=0;if(wp_lib_vars.getParams.hasOwnProperty('item_id'))e=wp_lib_vars.getParams.item_id;else if(wp_lib_vars.getParams.hasOwnProperty('member_id'))e=wp_lib_vars.getParams.member_id;d.attr({href:wp_lib_vars.adminUrl+'post.php?action=edit&post='+e,onclick:wp_lib_vars.onClick});break;case 'none':d.attr('name','dash_blank');break;default:wp_lib_render_page_element({},b);return;break;}if(a.hasOwnProperty('icon'))d.html(c('<div/>',{'class':'dash-icon dash-icon-medium dashicons dashicons-'+a.icon})).addClass('dash-icon-medium-parent');break;case 'dash-url':var d=c('<form/>',{'class':'dash-url-form'});c.each(a.params,function(a,b){d.append(c('<input/>',{type:'hidden',name:a,value:b}));});d.append(c('<a/>',elementObject).attr('href',wp_lib_vars.dashUrl+'&'+c.param(a.params)).addClass('dash-url'));break;case 'dash-button':d=c('<a/>',elementObject).addClass('dash-button dash-button-large');d.attr('type','button');switch(a.link){case 'dash-page':d.attr('name','dash_page');break;case 'post-type':d.attr({href:wp_lib_vars.adminUrl+'edit.php?post_type='+a.cpt,onclick:wp_lib_vars.onClick});break;case 'admin-url':d.attr({href:wp_lib_vars.adminUrl+a.url,onclick:wp_lib_vars.onClick});break;case 'url':d.attr({href:a.url,onclick:wp_lib_vars.onClick});break;}if(!a.hasOwnProperty('icon'))a.icon='no';d.html(c('<div/>',{'class':'dash-button-wrapper',html:[c('<div/>',{'class':'dash-icon dash-icon-large dashicons dashicons-'+a.icon}),c('<h4/>',{'class':'dash-button-text',html:a.bName})]}));break;case 'paras':if(a.hasOwnProperty('content'))if(a.content instanceof Array){elementObject.html=[];c(a.content).each(function(a,b){elementObject.html.push(c('<p/>',{html:b}));});}else if(typeof a.content==='string')elementObject.html=c('<p/>',{html:a.content});var d=c('<div/>',elementObject).addClass('dash-paras');break;case 'date':var d=c('<input/>',elementObject).attr({type:a.type}).addClass('dash-datepicker').datepicker();c('#ui-datepicker-div').addClass('ll-skin-melon');break;case 'input':var d=c('<input/>',elementObject);if(a.hasOwnProperty('attr'))c(a.attr).each(function(b,c){d.attr(c,a.attr[c]);});d.keydown(function(a){if(a.keyCode==13)d.siblings('a[type="button"]').click();});break;case 'select':var d=c('<select/>',elementObject);var f=[];c(a.options).each(function(b,d){f.push(c('<option/>',{'value':d.value,'html':d.html,'class':a.optionClass}));});d.html(f);break;case 'header':var d=c('<h'+a.size+'/>',elementObject);break;case 'div':var d=c('<div/>',elementObject);c(a.inner).each(function(a,b){wp_lib_render_page_element(b,d);});break;case 'strong':var d=c('<strong/>',elementObject);break;case 'metabox':var d=c('<div/>',elementObject).addClass('lib-metabox').append(c('<strong/>',{html:a.title}));var g=[];c(a.fields).each(function(a,b){var d=b[0];var e=b[1];if(e instanceof Array){if(e.length>1)d+='s';var f=[];c(e).each(function(a,b){if(a>0)f.push(', ');f.push(c('<a/>',{href:b[1],html:b[0]}));});e=f;}else if(e instanceof Object)e=wp_lib_render_page_element(e);g.push(c('<tr/>',{'class':'meta-row',html:[c('<th/>',{'html':d+':'}),c('<td/>',{'html':e})]}));});d.append(c('<table/>',{'class':'lib-metabox','html':g}));break;case 'form':var d=c('<form/>',elementObject);d.addClass('lib-form');d.attr('onsubmit','return false;');if(a.hasOwnProperty('content')&&a.content instanceof Array){var h=wp_lib_vars.dashUrl;a.content.forEach(function(a,b){if(a.hasOwnProperty('type')&&a.type==='hidden')h+='&'+a.name+'='+a.value;});a.content.forEach(function(a,b){var c=wp_lib_render_page_element(a,d);if(a.hasOwnProperty('type')&&a.type==='button'&&a.link==='page')c.attr('href',h+'&dash_page='+a.value);});}break;case 'dtable':var i=c('<thead/>',{});c(a.headers).each(function(a,b){c('<th/>',{html:b}).appendTo(i);});if(!a.hasOwnProperty('id'))elementObject.id='dynamic-table-'+Math.floor((Math.random()*100)+1);var j=c('<table/>',elementObject).addClass(['dynatable-table','wp-list-table','widefat','fixed','posts'].join(' ')).html([i,c('<tbody/>',{})]);var k=[];c.each(a.data,function(a,b){var d={};c.each(b,function(a,b){if(b instanceof Object)b=wp_lib_render_page_element(b).prop('outerHTML');d[a]=b;});k.push(d);});if(!a.hasOwnProperty('labels')||!a.labels.hasOwnProperty('records'))a.labels={records:'records'};var d=c('<div/>',{'class':'dynatable-wrap',html:j}).appendTo(b);j.dynatable({dataset:{records:k,perPageDefault:10,perPageOptions:[10,20,50,100]},params:{records:a.labels.records},inputs:{processingText:'<div class="dtable-process-wrap"><div class="dtable-process-icon dashicons dashicons-book-alt"></div></div>'}});c('.dynatable-head').each(function(a,b){c(b).addClass('manage-column');});return;break;case 'item-list':var j=c('<ul/>',elementObject).addClass('item-list');function l(a,b,d,e){var f=[c('<input/>',{type:'hidden',name:'item_id',value:b.item_id})];if(b.cover!==false)f.push(c('<div/>',{'class':'item-thumbnail','html':c('<div/>',{'class':'item-thumbnail-centrefix','html':c('<img/>',{'src':b.cover[0],'class':'item-thumbnail'})})}));else f.push(c('<div/>',{'class':'item-no-thumbnail'}));if(b.title.length>50)b.title=b.title.substring(0,48)+'...';var g=[c('<h4/>',{'class':'item-title','html':b.title})];if(b.authors!=false){var h=b.authors.join(', ');if(h.length>45)h=h.substring(0,43)+'...';g.push(c('<p/>',{'class':'item-authors','html':'Authors: '+h}));}g.push(c('<p/>',{'class':'item-status','html':'Status: '+b.status}));f.push(c('<div/>',{'class':'item-meta','html':g}));var i=c('<li/>',{'class':'single-item'});var j=c('<form/>',{'html':f}).appendTo(i);if(b.late==true)i.addClass('late-item');wp_lib_render_page_element({type:'button',link:'page',value:'manage-item',html:'Manage',classes:'item-manage',href:wp_lib_vars.dashUrl+'&dash_page=manage-item&item_id='+b.item_id},j);wp_lib_render_page_element({type:'button',link:'url',href:b.view,html:'View',classes:'item-view'},j);return i.prop('outerHTML');}var d=c('<div/>',{'class':'item-list-wrap',html:j}).appendTo(b);j.dynatable({table:{bodyRowSelector:'li'},writers:{_rowWriter:l},dataset:{records:a.data,perPageDefault:20,perPageOptions:[20,40,60,100]},params:{records:'items'},inputs:{processingText:'<div class="dtable-process-wrap"><div class="dtable-process-icon dashicons dashicons-book-alt"></div></div>'}});return;break;default:if(wp_lib_vars.debugMode){console.log('Dash element has unknown element type:');console.log(a);var d=c('<strong/>',{'html':'UNKNOWN ELEMENT TYPE<br/>','style':'color:red;'});}else var d=c('<div/>',{});break;}if(typeof b!=='undefined')d.appendTo(b);return d;}function wp_lib_format_tab_title(a){return a+' ‹ '+wp_lib_vars.siteName;}jQuery(function(a){a.dynatableSetup({table:{headRowSelector:'thead'},features:{pushState:false}});a.datepicker.setDefaults({dateFormat:'yy-mm-dd',inline:true,showOtherMonths:true});var b=wp_lib_vars.getParams;delete b.post_type;delete b.page;wp_lib_load_page(b,'first');window.onpopstate=function(a){wp_lib_load_page(a.state,'history');};jQuery('#wp-lib-workspace').on('click','a[name="dash_action"]',function(a){var b=a.currentTarget.value;var c=wp_lib_collect_form_params(a.target);wp_lib_do_action(b,c);return false;});jQuery('#wp-lib-workspace').on('click','a[name="dash_page"], a.dash-url',function(a){var b=wp_lib_collect_form_params(a.target);if(a.currentTarget.getAttribute('name')==='dash_page'){b.dash_page=a.currentTarget.getAttribute('value');delete b.wp_lib_ajax_nonce;}if(a.ctrlKey)return true;else{wp_lib_load_page(b);return false;}});jQuery('#wp-lib-workspace').on('click','img.item-thumbnail, div.item-no-thumbnail',function(a){var b=wp_lib_collect_form_params(a.target);b.dash_page='manage-item';wp_lib_load_page(b);return false;});});
